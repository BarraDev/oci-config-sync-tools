#!/bin/bash
# oci-config-import - Import OCI Terraform configuration from vault
#
# This script:
# 1. Parses _variables.tf to find all variables
# 2. Loads values from vault provider (Bitwarden/1Password)
# 3. Generates terraform.tfvars with all variables that have values in vault
# 4. Generates _backend.tf for OCI backend configuration
#
# Usage: oci-config-import [options] [terraform_dir]
#
# Examples:
#   oci-config-import terraform/config     # Generate tfvars for config project
#   oci-config-import terraform/infra      # Generate tfvars for infra project
#   oci-config-import --domain example.com # Specify domain explicitly

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOADER_ROOT="$(dirname "$SCRIPT_DIR")"

# Source libraries
source "$LOADER_ROOT/lib/common.sh"
source "$LOADER_ROOT/lib/tfvars-parser.sh"
source "$LOADER_ROOT/lib/vault-providers/_interface.sh"

# ============================================================================
# HELP
# ============================================================================

show_help() {
    cat << EOF
Usage: oci-config-import [options] [terraform_dir]

Import OCI Terraform configuration from vault provider.

The script analyzes _variables.tf to find all variables, loads their values
from the vault, and generates terraform.tfvars. It also generates _backend.tf
with OCI backend configuration (namespace, bucket, key, profile).

Options:
  --domain DOMAIN     Domain to load configuration for (e.g., example.com)
  --dry-run           Show what would be done without making changes
  --verbose           Enable verbose output for debugging
  --required-only     Only include required variables (without defaults)
  --help              Show this help message

Arguments:
  terraform_dir     Path to Terraform directory (default: current directory)

Examples:
  oci-config-import terraform/config          # Import config from vault
  oci-config-import terraform/infra           # Import infra from vault
  oci-config-import --domain example.com .    # Use specific domain
  oci-config-import --dry-run terraform/config # Preview changes

Generated files:
  terraform.tfvars  - Variable values from vault
  _backend.tf       - OCI backend configuration

Supported vault providers:
  - BitWarden (bw)
  - 1Password (op)

EOF
    exit 0
}

# ============================================================================
# ARGUMENT PARSING
# ============================================================================

DOMAIN=""
TERRAFORM_DIR=""
REQUIRED_ONLY=false

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --domain)
                DOMAIN="$2"
                shift 2
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            --verbose)
                VERBOSE=true
                shift
                ;;
            --required-only)
                REQUIRED_ONLY=true
                shift
                ;;
            --help|-h)
                show_help
                ;;
            -*)
                log_error "Unknown option: $1"
                echo "Use --help for usage information"
                exit 1
                ;;
            *)
                TERRAFORM_DIR="$1"
                shift
                ;;
        esac
    done

    # Default to current directory
    if [[ -z "$TERRAFORM_DIR" ]]; then
        TERRAFORM_DIR="."
    fi

    # Resolve to absolute path
    TERRAFORM_DIR="$(cd "$TERRAFORM_DIR" 2>/dev/null && pwd)" || {
        log_error "Directory not found: $TERRAFORM_DIR"
        exit 1
    }
}

# ============================================================================
# PROVIDER SELECTION
# ============================================================================

select_provider() {
    local available
    available=$(detect_available_providers)

    if [[ -z "$available" ]]; then
        log_error "No vault providers installed!"
        echo ""
        show_all_provider_instructions
        exit 1
    fi

    # If only one provider, use it
    local provider_count
    provider_count=$(echo "$available" | wc -w)

    if [[ $provider_count -eq 1 ]]; then
        echo "$available"
        return
    fi

    # Multiple providers - let user choose
    echo "Available vault providers:" >&2
    local i=1
    local providers=($available)
    for p in "${providers[@]}"; do
        echo "  $i) $p" >&2
        ((i++))
    done

    read -p "Select provider [1]: " choice
    choice=${choice:-1}

    if [[ $choice -lt 1 || $choice -gt ${#providers[@]} ]]; then
        log_error "Invalid selection"
        exit 1
    fi

    echo "${providers[$((choice-1))]}"
}

# ============================================================================
# DOMAIN SELECTION
# ============================================================================

select_domain() {
    local provider="$1"

    # If domain already specified, use it
    if [[ -n "$DOMAIN" ]]; then
        echo "$DOMAIN"
        return
    fi

    # Try to read from existing tfvars
    local tfvars_file="$TERRAFORM_DIR/terraform.tfvars"
    if [[ -f "$tfvars_file" ]]; then
        local existing_domain
        existing_domain=$(grep -E '^domain\s*=' "$tfvars_file" | sed -E 's/domain\s*=\s*"([^"]+)".*/\1/' | head -1)
        if [[ -n "$existing_domain" ]]; then
            log_verbose "Found domain in existing tfvars: $existing_domain"
            echo "$existing_domain"
            return
        fi
    fi

    # List items from vault
    log_step "Loading items from vault..."
    local items
    items=$(provider_list_items)

    if [[ -z "$items" ]]; then
        log_error "No 'OCI Terraform - *' items found in vault"
        log_info "Create an item named 'OCI Terraform - yourdomain.com' first"
        exit 1
    fi

    # Extract domains from item names
    local domains=()
    while IFS= read -r item; do
        local domain="${item#OCI Terraform - }"
        domains+=("$domain")
    done <<< "$items"

    if [[ ${#domains[@]} -eq 1 ]]; then
        echo "${domains[0]}"
        return
    fi

    # Multiple domains - let user choose
    echo "Available configurations:" >&2
    local i=1
    for d in "${domains[@]}"; do
        echo "  $i) $d" >&2
        ((i++))
    done

    read -p "Select configuration [1]: " choice
    choice=${choice:-1}

    if [[ $choice -lt 1 || $choice -gt ${#domains[@]} ]]; then
        log_error "Invalid selection"
        exit 1
    fi

    echo "${domains[$((choice-1))]}"
}

# ============================================================================
# BACKEND GENERATION
# ============================================================================

generate_backend_tf() {
    local domain="$1"
    local item_json="$2"
    local backend_file="$TERRAFORM_DIR/_backend.tf"

    # Get namespace from vault
    local namespace
    namespace=$(provider_get_field "$item_json" "oci_namespace")

    if [[ -z "$namespace" ]]; then
        log_warn "No oci_namespace found in vault"
        namespace=""
    fi

    # Determine state key - preserve existing key if _backend.tf exists
    local state_key=""
    if [[ -f "$backend_file" ]]; then
        state_key=$(grep -E '^\s*key\s*=' "$backend_file" | sed -E 's/.*key\s*=\s*"([^"]+)".*/\1/' | head -1)
        if [[ -n "$state_key" ]]; then
            log_verbose "Preserving existing state key: $state_key"
        fi
    fi

    # Fallback to directory-based key if not found
    if [[ -z "$state_key" ]]; then
        local dir_name
        dir_name=$(basename "$TERRAFORM_DIR")
        state_key="${dir_name}/terraform.tfstate"
    fi

    # Profile name based on domain: terraform_example_com (underscores instead of dots/hyphens)
    local profile="terraform_${domain//./_}"

    if $DRY_RUN; then
        log_dry_run "Generate $backend_file with:"
        echo "  namespace           = \"$namespace\""
        echo "  bucket              = \"terraform-states\""
        echo "  key                 = \"$state_key\""
        echo "  config_file_profile = \"$profile\""
    else
        log_step "Generating $backend_file..."

        # Backup existing file
        if [[ -f "$backend_file" ]]; then
            cp "$backend_file" "$backend_file.bak"
            log_verbose "Backed up existing file to $backend_file.bak"
        fi

        cat > "$backend_file" << EOF
# Generated by oci-config-import on $(date)
# Domain: $domain
#
# This file configures the OCI backend for Terraform state storage.
# It is generated and should not be committed to version control.

terraform {
  backend "oci" {
    namespace           = "$namespace"
    bucket              = "terraform-states"
    key                 = "$state_key"
    config_file_profile = "$profile"
  }
}
EOF

        log_info "Generated: $backend_file"
        log_info "  State key: $state_key"
        log_info "  OCI profile: $profile"
    fi
}

# ============================================================================
# MAIN LOGIC
# ============================================================================

main() {
    parse_args "$@"

    log_info "oci-config-import - Import OCI Terraform configuration from vault"
    log_verbose "Terraform directory: $TERRAFORM_DIR"

    # Check requirements
    check_requirements || exit 1

    # Find _variables.tf
    local vars_file="$TERRAFORM_DIR/_variables.tf"
    if [[ ! -f "$vars_file" ]]; then
        vars_file="$TERRAFORM_DIR/variables.tf"
    fi

    if [[ ! -f "$vars_file" ]]; then
        log_error "No _variables.tf or variables.tf found in $TERRAFORM_DIR"
        exit 1
    fi

    log_verbose "Variables file: $vars_file"

    # Parse variables
    log_step "Analyzing $vars_file..."
    local all_vars

    if $REQUIRED_ONLY; then
        # Only required variables (without defaults)
        all_vars=$(parse_required_variables "$vars_file")
        local var_count
        var_count=$(echo "$all_vars" | grep -c . || echo 0)
        log_info "Found $var_count required variables"
    else
        # All variables (default behavior)
        all_vars=$(parse_all_variables "$vars_file")
        local var_count
        var_count=$(echo "$all_vars" | grep -c . || echo 0)
        log_info "Found $var_count variables"
    fi

    if [[ -z "$all_vars" ]]; then
        log_info "No variables found in $vars_file"
        exit 0
    fi

    log_verbose "Variables: $(echo $all_vars | tr '\n' ' ')"

    # Select and load provider
    log_step "Detecting vault providers..."
    local provider
    provider=$(select_provider)
    log_info "Using provider: $provider"

    load_provider "$provider" || {
        log_error "Failed to load provider: $provider"
        exit 1
    }

    # Login to vault
    provider_login || {
        log_error "Failed to login to vault"
        exit 1
    }

    # Sync vault
    provider_sync

    # Select domain
    local domain
    domain=$(select_domain "$provider")
    log_info "Loading configuration for: $domain"

    # Load item from vault
    local item_name="OCI Terraform - $domain"
    log_step "Loading item: $item_name"

    local item_json
    item_json=$(provider_get_item "$item_name")

    if [[ -z "$item_json" || "$item_json" == "null" ]]; then
        log_error "Item not found: $item_name"
        exit 1
    fi

    # Generate backend.tf
    generate_backend_tf "$domain" "$item_json"

    # Generate tfvars
    local output_file="$TERRAFORM_DIR/terraform.tfvars"

    if $DRY_RUN; then
        log_dry_run "Generate $output_file with:"
    else
        log_step "Generating $output_file..."
        # Backup existing file
        if [[ -f "$output_file" ]]; then
            cp "$output_file" "$output_file.bak"
            log_verbose "Backed up existing file to $output_file.bak"
        fi
        # Start fresh
        echo "# Generated by oci-config-import on $(date)" > "$output_file"
        echo "# Domain: $domain" >> "$output_file"
        echo "" >> "$output_file"
    fi

    local written=0
    local missing=()

    while IFS= read -r var_name; do
        [[ -z "$var_name" ]] && continue

        log_verbose "Looking for field: $var_name"

        # Get value from vault - field name = variable name
        local value
        value=$(provider_get_field "$item_json" "$var_name")

        # Fallback: try legacy field names (oci_* prefix, etc.)
        if [[ -z "$value" ]]; then
            case "$var_name" in
                compartment_id) value=$(provider_get_field "$item_json" "oci_compartment_id") ;;
                tenancy_id) value=$(provider_get_field "$item_json" "oci_tenancy_ocid") ;;
                vault_id) value=$(provider_get_field "$item_json" "oci_vault_id") ;;
                region) value=$(provider_get_field "$item_json" "oci_region") ;;
                public_subnet_id) value=$(provider_get_field "$item_json" "oci_public_subnet_id") ;;
                namespace) value=$(provider_get_field "$item_json" "oci_namespace") ;;
                user_ocid) value=$(provider_get_field "$item_json" "oci_user_ocid") ;;
                fingerprint) value=$(provider_get_field "$item_json" "oci_fingerprint") ;;
                private_key) value=$(provider_get_field "$item_json" "oci_private_key") ;;
                github_token) value=$(provider_get_field "$item_json" "gh_token") ;;
            esac
            [[ -n "$value" ]] && log_verbose "  (using legacy field name)"
        fi

        if [[ -n "$value" ]]; then
            if $DRY_RUN; then
                if is_sensitive_var "$var_name"; then
                    echo "  $var_name = <sensitive>"
                else
                    echo "  $var_name = \"${value:0:50}$([ ${#value} -gt 50 ] && echo '...')\""
                fi
            else
                write_tfvar "$output_file" "$var_name" "$value"
            fi
            written=$((written + 1))
        else
            missing+=("$var_name")
            log_verbose "No value found for: $var_name"
        fi
    done <<< "$all_vars"

    echo ""
    log_info "Variables written: $written"

    if [[ ${#missing[@]} -gt 0 ]]; then
        log_verbose "No vault values for ${#missing[@]} variables (using defaults):"
        for m in "${missing[@]}"; do
            log_verbose "  - $m"
        done
    fi

    if ! $DRY_RUN; then
        log_info "Generated: $output_file"
        echo ""
        log_info "Next steps:"
        echo "  1. Ensure OCI CLI profile 'terraform_${domain//./_}' exists in ~/.oci/config"
        echo "  2. Run: terraform init"
        echo "  3. Run: terraform plan"
    fi
}

main "$@"
