#!/bin/bash
# tfvars-cleanup - Remove generated terraform.tfvars files
#
# This script removes terraform.tfvars files that were generated by tfvars-setup.
# Use this after running terraform apply to avoid leaving secrets on disk.
#
# Usage: tfvars-cleanup [terraform_dir]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOADER_ROOT="$(dirname "$SCRIPT_DIR")"

# Source common functions
source "$LOADER_ROOT/lib/common.sh"

show_help() {
    cat << EOF
Usage: tfvars-cleanup [options] [terraform_dir...]

Remove generated terraform.tfvars files to avoid leaving secrets on disk.

Options:
  --all           Clean all terraform directories in current project
  --dry-run       Show what would be deleted without deleting
  --keep-backup   Keep .tfvars.bak files (default: delete them too)
  --help          Show this help message

Arguments:
  terraform_dir   Path(s) to Terraform directory (default: current directory)

Examples:
  tfvars-cleanup terraform/config        # Clean specific directory
  tfvars-cleanup terraform/config terraform/infra  # Clean multiple
  tfvars-cleanup --all                   # Find and clean all terraform dirs
  tfvars-cleanup --dry-run               # Preview what would be deleted

EOF
    exit 0
}

# Parse arguments
DIRS=()
CLEAN_ALL=false
KEEP_BACKUP=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --all)
            CLEAN_ALL=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --keep-backup)
            KEEP_BACKUP=true
            shift
            ;;
        --help|-h)
            show_help
            ;;
        -*)
            log_error "Unknown option: $1"
            exit 1
            ;;
        *)
            DIRS+=("$1")
            shift
            ;;
    esac
done

# Find all terraform directories if --all
if $CLEAN_ALL; then
    while IFS= read -r dir; do
        [[ -n "$dir" ]] && DIRS+=("$dir")
    done < <(find . -name "*.tf" -type f 2>/dev/null | xargs -I{} dirname {} | sort -u)
fi

# Default to current directory
if [[ ${#DIRS[@]} -eq 0 ]]; then
    DIRS=(".")
fi

# Remove duplicates
DIRS=($(printf '%s\n' "${DIRS[@]}" | sort -u))

cleaned=0
for dir in "${DIRS[@]}"; do
    # Resolve to absolute path
    if [[ -d "$dir" ]]; then
        dir="$(cd "$dir" && pwd)"
    else
        log_warn "Directory not found: $dir"
        continue
    fi

    tfvars_file="$dir/terraform.tfvars"
    backup_file="$dir/terraform.tfvars.bak"
    backend_file="$dir/_backend.tf"
    backend_backup="$dir/_backend.tf.bak"

    # Check for tfvars file
    if [[ -f "$tfvars_file" ]]; then
        # Verify it was generated by tfvars-setup
        if grep -q "Generated by tfvars-setup" "$tfvars_file" 2>/dev/null; then
            if $DRY_RUN; then
                log_dry_run "Remove $tfvars_file"
            else
                rm -f "$tfvars_file"
                log_info "Removed: $tfvars_file"
                ((cleaned++))
            fi
        else
            log_verbose "Skipping (not generated by tfvars-setup): $tfvars_file"
        fi
    fi

    # Check for backend.tf file
    if [[ -f "$backend_file" ]]; then
        # Verify it was generated by tfvars-setup
        if grep -q "Generated by tfvars-setup" "$backend_file" 2>/dev/null; then
            if $DRY_RUN; then
                log_dry_run "Remove $backend_file"
            else
                rm -f "$backend_file"
                log_info "Removed: $backend_file"
                ((cleaned++))
            fi
        else
            log_verbose "Skipping (not generated by tfvars-setup): $backend_file"
        fi
    fi

    # Check for backup files
    if [[ -f "$backup_file" ]] && ! $KEEP_BACKUP; then
        if $DRY_RUN; then
            log_dry_run "Remove $backup_file"
        else
            rm -f "$backup_file"
            log_info "Removed: $backup_file"
            ((cleaned++))
        fi
    fi

    if [[ -f "$backend_backup" ]] && ! $KEEP_BACKUP; then
        if $DRY_RUN; then
            log_dry_run "Remove $backend_backup"
        else
            rm -f "$backend_backup"
            log_info "Removed: $backend_backup"
            ((cleaned++))
        fi
    fi
done

if $DRY_RUN; then
    log_info "Dry run complete. No files were deleted."
else
    log_info "Cleanup complete. Removed $cleaned file(s)."
fi
