#!/bin/bash
# oci-config-clean - Remove generated OCI Terraform configuration files
#
# This script removes terraform.tfvars and _backend.tf files that were
# generated by oci-config-import. Use this after running terraform apply
# to avoid leaving secrets on disk.
#
# Usage: oci-config-clean [terraform_dir]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOADER_ROOT="$(dirname "$SCRIPT_DIR")"

# Source common functions
source "$LOADER_ROOT/lib/common.sh"

show_help() {
    cat << EOF
Usage: oci-config-clean [options] [terraform_dir...]

Remove generated OCI Terraform configuration files to avoid leaving secrets on disk.

SAFETY: By default, verifies that critical variables are backed up in vault before
deletion. Use --force to bypass this safety check.

Options:
  --all              Clean all terraform directories in current project
  --dry-run          Show what would be deleted without deleting
  --keep-backup      Keep .bak files (default: delete them too)
  --no-verify-vault  Skip vault backup verification (unsafe)
  --force            Skip all safety checks (same as --no-verify-vault)
  --help             Show this help message

Arguments:
  terraform_dir      Path(s) to Terraform directory (default: current directory)

Examples:
  oci-config-clean terraform/config        # Clean with vault verification
  oci-config-clean --force terraform/config  # Clean without verification
  oci-config-clean terraform/config terraform/infra  # Clean multiple
  oci-config-clean --all                   # Find and clean all terraform dirs
  oci-config-clean --dry-run               # Preview what would be deleted

Safety:
  Before removing terraform.tfvars, the script verifies that:
  - A vault backup exists (Bitwarden/1Password/LastPass)
  - Critical variables (compartment_id, vault_id, region, domain) match
  - Use --force to skip verification (not recommended)

EOF
    exit 0
}

# Parse arguments
DIRS=()
CLEAN_ALL=false
KEEP_BACKUP=false
VERIFY_VAULT=true

while [[ $# -gt 0 ]]; do
    case "$1" in
        --all)
            CLEAN_ALL=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --keep-backup)
            KEEP_BACKUP=true
            shift
            ;;
        --no-verify-vault|--force)
            VERIFY_VAULT=false
            shift
            ;;
        --help|-h)
            show_help
            ;;
        -*)
            log_error "Unknown option: $1"
            exit 1
            ;;
        *)
            DIRS+=("$1")
            shift
            ;;
    esac
done

# Find all terraform directories if --all
if $CLEAN_ALL; then
    while IFS= read -r dir; do
        [[ -n "$dir" ]] && DIRS+=("$dir")
    done < <(find . -name "*.tf" -type f 2>/dev/null | xargs -I{} dirname {} | sort -u)
fi

# Default to current directory
if [[ ${#DIRS[@]} -eq 0 ]]; then
    DIRS=(".")
fi

# Remove duplicates
DIRS=($(printf '%s\n' "${DIRS[@]}" | sort -u))

# Verify vault backups if enabled (not in dry-run mode)
if $VERIFY_VAULT && ! $DRY_RUN; then
    log_step "Verifying vault backups..."
    verification_failed=false

    for dir in "${DIRS[@]}"; do
        # Resolve to absolute path
        if [[ -d "$dir" ]]; then
            abs_dir="$(cd "$dir" && pwd)"
        else
            continue
        fi

        tfvars_file="$abs_dir/terraform.tfvars"

        # Only verify if tfvars exists and was generated by oci-config-import
        if [[ -f "$tfvars_file" ]] && grep -qE "Generated by (oci-config-import|tfvars-setup)" "$tfvars_file" 2>/dev/null; then
            if ! verify_vault_backup "$abs_dir"; then
                verification_failed=true
                log_error "Vault verification failed for: $abs_dir"
            fi
        fi
    done

    if $verification_failed; then
        echo ""
        log_error "Safety check failed: Vault backup verification failed"
        log_warn "Options:"
        log_warn "  1. Run 'oci-config-export <dir>' to backup to vault"
        log_warn "  2. Use --force to bypass verification (not recommended)"
        exit 1
    fi

    echo ""
fi

cleaned=0
for dir in "${DIRS[@]}"; do
    # Resolve to absolute path
    if [[ -d "$dir" ]]; then
        dir="$(cd "$dir" && pwd)"
    else
        log_warn "Directory not found: $dir"
        continue
    fi

    tfvars_file="$dir/terraform.tfvars"
    backup_file="$dir/terraform.tfvars.bak"
    backend_file="$dir/_backend.tf"
    backend_backup="$dir/_backend.tf.bak"

    # Check for tfvars file
    if [[ -f "$tfvars_file" ]]; then
        # Verify it was generated by oci-config-import (or legacy tfvars-setup)
        if grep -qE "Generated by (oci-config-import|tfvars-setup)" "$tfvars_file" 2>/dev/null; then
            if $DRY_RUN; then
                log_dry_run "Remove $tfvars_file"
            else
                rm -f "$tfvars_file"
                log_info "Removed: $tfvars_file"
                ((cleaned++))
            fi
        else
            log_verbose "Skipping (not generated by oci-config-import): $tfvars_file"
        fi
    fi

    # Check for backend.tf file
    if [[ -f "$backend_file" ]]; then
        # Verify it was generated by oci-config-import (or legacy tfvars-setup)
        if grep -qE "Generated by (oci-config-import|tfvars-setup)" "$backend_file" 2>/dev/null; then
            if $DRY_RUN; then
                log_dry_run "Remove $backend_file"
            else
                rm -f "$backend_file"
                log_info "Removed: $backend_file"
                ((cleaned++))
            fi
        else
            log_verbose "Skipping (not generated by oci-config-import): $backend_file"
        fi
    fi

    # Check for backup files
    if [[ -f "$backup_file" ]] && ! $KEEP_BACKUP; then
        if $DRY_RUN; then
            log_dry_run "Remove $backup_file"
        else
            rm -f "$backup_file"
            log_info "Removed: $backup_file"
            ((cleaned++))
        fi
    fi

    if [[ -f "$backend_backup" ]] && ! $KEEP_BACKUP; then
        if $DRY_RUN; then
            log_dry_run "Remove $backend_backup"
        else
            rm -f "$backend_backup"
            log_info "Removed: $backend_backup"
            ((cleaned++))
        fi
    fi
done

if $DRY_RUN; then
    log_info "Dry run complete. No files were deleted."
else
    log_info "Cleanup complete. Removed $cleaned file(s)."
fi
